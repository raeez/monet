#!/bin/bash

if [ `whoami` != root ]; then
	echo Please run this script as root, or using sudo
	exit
fi

echo ""
echo "**********************************"
echo "* Bootstrapping Styx Environment *"
echo "**********************************"
echo ""

# system dependencies
apt-get -y install git \
					nginx \
					mongodb \
					python-setuptools \

# styx env
easy_install virtualenv
virtualenv styx
. styx/bin/activate

# python dependencies
easy_install Flask \
				flup \
				sphinx \
				pymongo \
				ipython \

ln -s $(pwd)/styx/bin/python /usr/bin/styx.python

chown -R ubuntu .

# deploy nginx configuration
cp nginx/nginx.conf /etc/nginx/nginx.conf
rm /etc/nginx/sites-enabled/default
rm /etc/nginx/sites-available/default
mkdir /var/manhattan
mkdir /var/manhattan/log
mkdir /var/manhattan/log/nginx
mkdir /var/www/log

echo ""
echo "***************************"
echo "* Deploying core services *"
echo "***************************"
echo ""

mkdir /data/db #mongodb

cp upstart/*.conf /etc/init/

cp fcgi/cerberus.fcgi /var/www/cerberus.fcgi
cp fcgi/hermes.fcgi /var/www/hermes.fcgi
cp fcgi/gaia.fcgi /var/www/gaia.fcgi

echo "*** styx *** starting cerberus..."
start cerberus.styx
echo "*** styx *** starting hermes..."
start hermes.styx
echo "*** styx *** starting gaia..."
start gaia.styx
echo "*** styx *** starting nginx..."
start nginx.styx
echo "*** styx *** starting mongodb..."
start mongodb.styx

echo ""
echo "***************"
echo "* styx::Done! *"
echo "***************"
echo ""
